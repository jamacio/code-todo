(()=>{var e={398:e=>{"use strict";e.exports=require("vscode")},497:(e,t,s)=>{const i=s(398),o=s(928),r=s(896).promises,{createReadStream:a}=s(896),n=s(785),c=["BUG","HACK","FIXME","TODO","XXX"],h=`\\b(${c.join("|")})(?=\\s|:)[:]?\\s*(.*)`;class l{constructor(e){this.context=e,this.cache=new Map,this.fileMap=new Map,this.decorations=new Map,this.isScanning=!1,this.documentChangeTimer=null,this.updateTimers=new Map,this._onDidChangeTreeData=new i.EventEmitter,this.onDidChangeTreeData=this._onDidChangeTreeData.event,this.decorationType=i.window.createTextEditorDecorationType({backgroundColor:"rgba(255, 255, 255, 0.68)",color:"rgba(0, 0, 0, 0.68)",border:"1px solid rgba(255, 255, 255, 0.68)",borderRadius:"3px",overviewRulerColor:"yellow",overviewRulerLane:i.OverviewRulerLane.Right}),this.initialize()}async initialize(){this.loadCacheSync(),this.fileMap.size>0&&(this.refresh(),this.applyHighlightsToActiveEditor()),this.setupWatchers(),setTimeout((()=>this.startScan()),100)}loadCacheSync(){try{const e=this.context.globalState.get("todoCache_v42")||{};Object.entries(e).forEach((([e,t])=>{t?.items&&Array.isArray(t.items)&&t.items.length>0&&(this.cache.set(e,t),this.fileMap.set(e,t.items))}))}catch(e){console.error("Cache load failed:",e)}}async startScan(){if(!this.isScanning){this.isScanning=!0;try{const e=await i.workspace.findFiles("**/*.{js,ts,jsx,tsx,vue,php,py,java,cs,cpp,h,hpp,html,css,scss,md,txt,yaml,yml,json}","**/{node_modules,vendor,dist,out,build,.git,.vscode,coverage,tmp,temp,__pycache__}/**"),t=[];for(const s of e){const e=s.fsPath;try{const s=await r.stat(e),i=this.cache.get(e);i&&i.mtime===s.mtimeMs&&i.size===s.size||t.push(e)}catch(t){this.handleFileDelete(e)}}await this.processFilesInBatches(t),await this.saveCache()}catch(e){console.error("Scan failed:",e)}finally{this.isScanning=!1}}}async processFilesInBatches(e){let t=0;for(let s=0;s<e.length;s+=10){const i=e.slice(s,s+10);await Promise.all(i.map((async e=>{try{await this.processFile(e),t++,t%20==0&&this.refresh()}catch(t){console.error(`Error processing ${e}:`,t)}}))),await new Promise((e=>setTimeout(e,10)))}this.refresh()}async processFile(e){try{const t=await r.stat(e);if(t.size>2097152)return;const s=await this.parseFile(e);s.length>0?(this.fileMap.set(e,s),this.cache.set(e,{mtime:t.mtimeMs,size:t.size,items:s})):(this.fileMap.delete(e),this.cache.delete(e));const o=i.window.activeTextEditor;o&&o.document.uri.fsPath===e&&this.applyHighlights(o)}catch(t){throw"ENOENT"===t.code&&this.handleFileDelete(e),t}}async parseFile(e){return new Promise(((t,s)=>{const i=[],o=a(e,{encoding:"utf8"}),r=n.createInterface({input:o,crlfDelay:1/0});let l=0;r.on("line",(t=>{const s=new RegExp(h,"g");let o;for(;null!==(o=s.exec(t));){const t=o[1].toUpperCase(),s=o[2].trim();c.includes(t)&&i.push({tag:t,text:s,line:l,column:o.index,file:e})}l++})),r.on("close",(()=>t(i))),r.on("error",s)}))}setupWatchers(){const e=i.workspace.createFileSystemWatcher("**/*");this.context.subscriptions.push(e,e.onDidChange((e=>this.handleFileChange(e.fsPath))),e.onDidCreate((e=>this.handleFileChange(e.fsPath))),e.onDidDelete((e=>this.handleFileDelete(e.fsPath))),i.window.onDidChangeActiveTextEditor((e=>{e&&this.applyHighlights(e)})),i.workspace.onDidChangeTextDocument((e=>{this.handleDocumentChange(e.document)})),i.workspace.onDidSaveTextDocument((e=>{this.handleDocumentSave(e)})))}handleFileChange(e){this.shouldProcessFile(e)&&this.debounceFileUpdate(e)}debounceFileUpdate(e){clearTimeout(this.updateTimers.get(e)),this.updateTimers.set(e,setTimeout((async()=>{try{await this.processFile(e),this.refresh(),await this.saveCache()}catch(t){console.error(`Error updating ${e}:`,t)}}),1e3))}handleFileDelete(e){this.fileMap.delete(e),this.cache.delete(e),this.refresh()}shouldProcessFile(e){const t=o.extname(e).toLowerCase();return![".png",".jpg",".jpeg",".gif",".svg",".ico",".woff",".woff2",".ttf",".eot"].includes(t)&&![/\.min\.(js|css)$/,/\.map$/,/package-lock\.json$/,/yarn\.lock$/].some((t=>t.test(e)))}handleDocumentChange(e){this.shouldProcessFile(e.uri.fsPath)&&(clearTimeout(this.documentChangeTimer),this.documentChangeTimer=setTimeout((()=>{this.processDocumentInMemory(e)}),300))}handleDocumentSave(e){this.shouldProcessFile(e.uri.fsPath)&&this.processDocumentFromFile(e.uri.fsPath)}async processDocumentInMemory(e){try{const t=e.uri.fsPath,s=e.getText(),o=this.parseContent(s,t);o.length>0?this.fileMap.set(t,o):this.fileMap.delete(t);const r=i.window.activeTextEditor;r&&r.document===e&&this.applyHighlights(r),this.refresh()}catch(e){console.error("Error processing document in memory:",e)}}async processDocumentFromFile(e){try{await this.processFile(e),this.refresh(),await this.saveCache()}catch(e){console.error("Error processing document from file:",e)}}parseContent(e,t){const s=[];return e.split("\n").forEach(((e,i)=>{const o=new RegExp(h,"g");let r;for(;null!==(r=o.exec(e));){const e=r[1].toUpperCase(),o=r[2].trim();c.includes(e)&&s.push({tag:e,text:o,line:i,column:r.index,file:t})}})),s}applyHighlightsToActiveEditor(){const e=i.window.activeTextEditor;e&&this.applyHighlights(e)}applyHighlights(e){if(!e)return;const t=e.document.uri.fsPath,s=this.fileMap.get(t)||[];(this.decorations.get(t)||[]).forEach((e=>e.dispose()));const o=s.map((e=>new i.Range(new i.Position(e.line,e.column),new i.Position(e.line,e.column+e.tag.length))));e.setDecorations(this.decorationType,o)}refresh(){this._onDidChangeTreeData.fire()}async saveCache(){try{const e=Object.fromEntries(this.cache);await this.context.globalState.update("todoCache_v42",e)}catch(e){console.error("Cache save error:",e)}}getTreeItem(e){return e}async getChildren(e){return e?e.children||[]:this.buildTree()}buildTree(){const e=i.workspace.workspaceFolders?.[0]?.uri.fsPath;if(!e)return[];const t=new Map;return this.fileMap.forEach(((s,i)=>{if(!i.startsWith(e))return;const r=o.relative(e,i).split(o.sep),a=r.pop();let n=t,c=e;r.forEach((e=>{c=o.join(c,e),n.has(e)||n.set(e,{type:"folder",path:c,children:new Map,files:new Map}),n=n.get(e).children})),n.has("__files__")||n.set("__files__",new Map),n.get("__files__").set(a,{filePath:i,items:s})})),this.buildTreeFromStructure(t,e)}buildTreeFromStructure(e,t){const s=[];return e.forEach(((e,t)=>{if("__files__"===t)e.forEach(((e,t)=>{const r={label:t,tooltip:o.relative(i.workspace.workspaceFolders[0].uri.fsPath,e.filePath),collapsibleState:i.TreeItemCollapsibleState.Collapsed,iconPath:i.ThemeIcon.File,children:[]};e.items.forEach((t=>{r.children.push({label:`[${t.tag}] ${t.text}`,description:`Line ${t.line+1}`,command:{command:"vscode.open",title:"Open File",arguments:[i.Uri.file(e.filePath),{selection:new i.Range(t.line,0,t.line,0)}]},iconPath:this.getIconForTag(t.tag)})})),r.children.length>0&&s.push(r)}));else{const r={label:t,tooltip:o.relative(i.workspace.workspaceFolders[0].uri.fsPath,e.path),collapsibleState:i.TreeItemCollapsibleState.Collapsed,iconPath:i.ThemeIcon.Folder,children:this.buildTreeFromStructure(e.children,e.path)};r.children.length>0&&s.push(r)}})),s.sort(((e,t)=>"folder"===e.iconPath.id&&"folder"!==t.iconPath.id?-1:"folder"!==e.iconPath.id&&"folder"===t.iconPath.id?1:e.label.localeCompare(t.label)))}getIconForTag(e){return{TODO:new i.ThemeIcon("checklist"),FIXME:new i.ThemeIcon("tools"),BUG:new i.ThemeIcon("bug"),HACK:new i.ThemeIcon("warning"),XXX:new i.ThemeIcon("alert")}[e]||new i.ThemeIcon("comment")}}e.exports={activate:function(e){const t=new l(e);return e.subscriptions.push(i.window.registerTreeDataProvider("todoTreeView",t),i.commands.registerCommand("codeTODO.refresh",(async()=>{t.fileMap.clear(),t.cache.clear(),await t.startScan()}))),t},deactivate:function(){}}},785:e=>{"use strict";e.exports=require("readline")},896:e=>{"use strict";e.exports=require("fs")},928:e=>{"use strict";e.exports=require("path")}},t={},s=function s(i){var o=t[i];if(void 0!==o)return o.exports;var r=t[i]={exports:{}};return e[i](r,r.exports,s),r.exports}(497);module.exports=s})();
//# sourceMappingURL=extension.js.map