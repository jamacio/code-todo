(()=>{var e={398:e=>{"use strict";e.exports=require("vscode")},497:(e,t,i)=>{const s=i(398),a=i(928),r=i(896).promises,{createReadStream:o}=i(896),n=i(785),c=["BUG","HACK","FIXME","TODO","XXX"],h=`\\b(${c.join("|")})(?=\\s|:)[:]?\\s*(.*)`;class l{constructor(e){this.context=e,this.cache=new Map,this.fileMap=new Map,this.activeOperations=new Set,this.processingQueue=new Set,this.debounceTimer=null,this.isInitialized=!1,this.decorationType=s.window.createTextEditorDecorationType({overviewRulerColor:new s.ThemeColor("editorOverviewRuler.addedForeground"),backgroundColor:"rgba(255, 255, 255, 0.68)",color:"rgba(0, 0, 0, 0.68)",border:"1px solid rgba(255, 255, 255, 0.68)",borderRadius:"3px",overviewRulerLane:s.OverviewRulerLane.Right}),this._onDidChange=new s.EventEmitter,this.onDidChangeTreeData=this._onDidChange.event,this.initialize().catch((e=>s.window.showErrorMessage(`Initialization error: ${e.message}`)))}async initialize(){await this.loadCache(),this.refresh(),this.setupWatchers(),this.applyHighlightsToAllEditors(),await this.startBackgroundProcessing()}refresh(){this._onDidChange.fire()}async startBackgroundProcessing(){try{const e=await this.context.globalState.get("lastFullScanTimestamp",0),t=Date.now();t-e>6048e5&&(await this.performWeeklyScan(t),await this.context.globalState.update("lastFullScanTimestamp",t));const i=await s.workspace.findFiles("**/*.{js,ts,jsx,tsx,php,py,java,cs,cpp,h,html,css,md,json}","**/{node_modules,vendor,dist,out,build,.git}/**");this.updateFileList(i),this.isInitialized=!0}catch(e){s.window.showErrorMessage(`Background processing failed: ${e.message}`)}}async performWeeklyScan(e){this.cache.clear(),this.fileMap.clear(),this.refresh(),await this.saveCache()}updateFileList(e){const t=new Set(e.map((e=>e.fsPath)));Array.from(this.cache.keys()).forEach((e=>{t.has(e)||this.handleFileDelete(s.Uri.file(e))})),e.forEach((e=>{this.cache.has(e.fsPath)||this.queueProcessing(e.fsPath,!0)}))}setupWatchers(){const e=s.workspace.createFileSystemWatcher("**/*");this.context.subscriptions.push(e,e.onDidChange((e=>this.queueProcessing(e.fsPath,!0))),e.onDidCreate((e=>this.queueProcessing(e.fsPath,!0))),e.onDidDelete((e=>this.handleFileDelete(e))),s.window.onDidChangeActiveTextEditor((e=>this.applyHighlights(e))))}handleFileDelete(e){const t=e.fsPath;this.fileMap.delete(t),this.cache.delete(t),this.updateView(!0),this.applyHighlightsToAllEditors()}queueProcessing(e,t=!1){this.processingQueue.has(e)||(this.processingQueue.add(e),this.debounceProcess())}debounceProcess(){clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout((()=>this.processQueue()),25)}async processQueue(){if(this.isInitialized)for(;this.processingQueue.size>0;){const e=Array.from(this.processingQueue).slice(0,100);this.processingQueue=new Set(Array.from(this.processingQueue).slice(100)),await Promise.all(e.map((e=>this.processSingleFile(e).catch((t=>console.error(`Error processing ${e}:`,t)))))),this.updateView(!0)}}async processSingleFile(e){if(!this.activeOperations.has(e)){this.activeOperations.add(e);try{const t=await r.stat(e),i=this.cache.get(e);if(i?.mtime===t.mtimeMs)return;const s=await this.parseFileStream(e);this.updateFileData(e,s,t.mtimeMs),this.applyHighlightsForFile(e)}catch(t){"ENOENT"===t.code?this.handleFileDelete(s.Uri.file(e)):console.error(`Error processing ${e}:`,t)}finally{this.activeOperations.delete(e)}}}applyHighlightsForFile(e){s.window.visibleTextEditors.forEach((t=>{t.document.uri.fsPath===e&&this.applyHighlights(t)}))}updateFileData(e,t,i){const s=new Map(t.map((e=>[`${e.line}:${e.position}`,e]))),a=Array.from(s.values());a.length>0?(this.fileMap.set(e,a),this.cache.set(e,{mtime:i,items:a})):(this.fileMap.delete(e),this.cache.delete(e))}async parseFileStream(e){return new Promise(((t,i)=>{const s=[],a=n.createInterface({input:o(e,"utf8"),crlfDelay:1/0});let r=0;a.on("line",(t=>{const i=[...t.matchAll(new RegExp(h,"g"))];for(const t of i){const[i,a,o]=t;c.includes(a.toUpperCase())&&s.push({tag:a.toUpperCase(),text:o.trim(),line:r,position:t.index,file:e})}r++})),a.on("close",(()=>t(s))),a.on("error",i)}))}async loadCache(){try{const e=await this.context.globalState.get("todoCache_v19",{});Object.entries(e).forEach((([e,t])=>{t?.items&&(this.cache.set(e,t),this.fileMap.set(e,t.items))}))}catch(e){s.window.showErrorMessage(`Cache load failed: ${e.message}`)}}async saveCache(){try{await this.context.globalState.update("todoCache_v19",Object.fromEntries(this.cache))}catch(e){console.error("Cache save error:",e)}}updateView(e=!1){this.refresh(),e&&this.saveCache()}applyHighlightsToAllEditors(){s.window.visibleTextEditors.forEach((e=>this.applyHighlights(e)))}applyHighlights(e){try{if(!e)return;const t=e.document.uri.fsPath,i=(this.fileMap.get(t)||[]).filter((e=>c.includes(e.tag))).map((e=>new s.Range(new s.Position(e.line,e.position),new s.Position(e.line,e.position+e.tag.length))));e.setDecorations(this.decorationType,i)}catch(e){console.error("Highlight error:",e)}}getTreeItem(e){return e}async getChildren(e){return e?e.children:this.buildTreeStructure()}buildTreeStructure(){const e=[],t=s.workspace.workspaceFolders?.[0]?.uri.fsPath;return t?(this.fileMap.forEach(((i,r)=>{if(!r.startsWith(t))return;const o=a.relative(t,r);let n=e;o.split(a.sep).forEach(((e,i)=>{let r=n.find((t=>t.label===e));r||(r={label:e,children:[],collapsibleState:s.TreeItemCollapsibleState.Collapsed,path:a.join(t,...o.split(a.sep).slice(0,i+1))},n.push(r)),n=r.children})),i.forEach((e=>n.push({label:`[${e.tag}] ${e.text}`,description:`Line ${e.line+1}`,command:{command:"vscode.open",title:"Open File",arguments:[s.Uri.file(r),{selection:new s.Range(e.line,0,e.line,0)}]}})))})),e.sort(((e,t)=>e.label.localeCompare(t.label)))):e}}e.exports={activate:function(e){const t=new l(e);return e.subscriptions.push(s.window.registerTreeDataProvider("todoTreeView",t),s.commands.registerCommand("codeTODO.refresh",(()=>t.startBackgroundProcessing())),{dispose:()=>t.saveCache()}),t},deactivate:function(){}}},785:e=>{"use strict";e.exports=require("readline")},896:e=>{"use strict";e.exports=require("fs")},928:e=>{"use strict";e.exports=require("path")}},t={},i=function i(s){var a=t[s];if(void 0!==a)return a.exports;var r=t[s]={exports:{}};return e[s](r,r.exports,i),r.exports}(497);module.exports=i})();
//# sourceMappingURL=extension.js.map